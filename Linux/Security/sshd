# This is the sshd server system-wide configuration file.  See
# sshd_config(5) for more information.

# This sshd was compiled with PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games

# The strategy used for options in the default sshd_config shipped with
# OpenSSH is to specify options with their default value where
# possible, but leave them commented.  Uncommented options override the
# default value.

Include /etc/ssh/sshd_config.d/*.conf

# When systemd socket activation is used (the default), the socket
# configuration must be re-generated after changing Port, AddressFamily, or
# ListenAddress.
#
# For changes to take effect, run:
#
#   systemctl daemon-reload
#   systemctl restart ssh.socket
#

Port 22
AddressFamily inet  # Use inet for IPv4 only, or inet6 for IPv6 only, or 'any' for both
ListenAddress 0.0.0.0  # Specify specific IP if server has multiple interfaces

# Host Keys
HostKey /etc/ssh/ssh_host_ecdsa_key
HostKey /etc/ssh/ssh_host_ed25519_key

# Ciphers and keying
KexAlgorithms curve25519-sha256,curve25519-sha256@libssh.org,diffie-hellman-group16-sha512,diffie-hellman-group18-sha512,diffie-hellman-group-exchange-sha256
Ciphers chacha20-poly1305@openssh.com,aes256-gcm@openssh.com,aes128-gcm@openssh.com,aes256-ctr,aes192-ctr,aes128-ctr
MACs hmac-sha2-512-etm@openssh.com,hmac-sha2-256-etm@openssh.com,hmac-sha2-512,hmac-sha2-256
RekeyLimit 512M 1h  # Rekey after 512MB or 1 hour

# Logging
SyslogFacility AUTHPRIV
LogLevel VERBOSE # DEBUG for troubleshooting

# Authentication:
AuthenticationMethods publickey
LoginGraceTime 20s # Limit exposure
PermitRootLogin no # Root should never login directly
StrictModes yes # Check file permissions
MaxAuthTries 3 # Limit brute force attempts

# Public Key Auth
PubkeyAuthentication yes # Public key auth
AuthorizedKeysFile .ssh/authorized_keys
PubkeyAcceptedKeyTypes ssh-ed25519,ssh-ed25519-cert-v01@openssh.com,sk-ssh-ed25519@openssh.com,sk-ssh-ed25519-cert-v01@openssh.com,rsa-sha2-256,rsa-sha2-512

# Certificate-based authentication
#AuthorizedPrincipalsFile /etc/ssh/auth_principals/%u
#AuthorizedKeysCommand none
#AuthorizedKeysCommandUser nobody
#TrustedUserCAKeys /etc/ssh/ca_user_key.pub

# Disable weak auth methods
HostbasedAuthentication no
IgnoreUserKnownHosts yes
IgnoreRhosts yes # Don't read the user's ~/.rhosts and ~/.shosts files
PasswordAuthentication no
PermitEmptyPasswords no
KbdInteractiveAuthentication no
KerberosAuthentication no
GSSAPIAuthentication no

# PAM
UsePAM yes

# Forwarding
# PermitOpen none  # Disable all port forwarding
# PermitOpen localhost:* 10.0.0.0/8:*  # Restrict forwarding destinations
AllowAgentForwarding no
AllowTcpForwarding yes # port forwarding/tunneling
AllowStreamLocalForwarding no
GatewayPorts no
X11Forwarding no
PermitTTY yes # Terminal allocation
PermitUserEnvironment no # no ~/.ssh/environment processing
PermitTunnel no # Layer 3 tunneling

# Access Control
# AllowUsers user1
# AllowGroups sshusers
# DenyUsers baduser
DenyGroups nologin

# Banner & Messages
PrintMotd no
PrintLastLog yes

# Performance Optimization
Compression delayed # Against CRIME-style attacks
MaxSessions 3 # Limit resource usage
ClientAliveInterval 60 # Send keepalive for every 1 min
ClientAliveCountMax 2 # Disconnect after 2mins idle
UseDNS no # No reverse DNS lookup - reducing latency
TCPKeepAlive yes # Detect dead connections at TCP level

# Security
DebianBanner no  # Don't reveal OS version
PermitUserRC no  # Prevent ~/.ssh/rc execution
FingerprintHash sha256 # Log all fingerprints
RequiredRSASize 2048  # Reject weak RSA keys
HostKeyAlgorithms ssh-ed25519,ssh-ed25519-cert-v01@openssh.com,rsa-sha2-512,rsa-sha2-256

# Connection management
MaxStartups 5:50:10 # Start dropping at 5, reject all at 10
PerSourceMaxStartups 2
PerSourceNetBlockSize 32:128
ChannelTimeout session:idle=300 # Prevent stuck channels

# Allow client to pass locale environment variables
AcceptEnv LANG LC_*
